<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Society Room Booking</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow-x: hidden; }
    .calendar-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrWL_TVLDFhuztPjsBgmLLGNUxIhtBZ3xQb6ypj8QerkGjjp3-NGxnspflJOVDJMb9uw/exec';

    function Calendar({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
    }

    function Clock({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
    }

    function User({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
    }

    function Home({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
    }

    function X({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
    }

    function RefreshCw({ className }) {
      return <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;
    }

    function App() {
      const [bookings, setBookings] = useState({});
      const [selectedSlot, setSelectedSlot] = useState(null);
      const [bookingForm, setBookingForm] = useState({ name: '', purpose: '' });
      const [loading, setLoading] = useState(false);
      const [lastRefresh, setLastRefresh] = useState(new Date());
      
      function getSunday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day;
        return new Date(d.setDate(diff));
      }
      
      const baseWeekStart = getSunday(new Date());
      const [currentWeekStart, setCurrentWeekStart] = useState(baseWeekStart);

      function formatDate(date) {
        return date.toISOString().split('T')[0];
      }

      function formatTime(hour) {
        return `${hour}:00`;
      }
      
      function getWeekNumber() {
        const diffTime = currentWeekStart - baseWeekStart;
        const diffWeeks = Math.round(diffTime / (7 * 24 * 60 * 60 * 1000));
        return diffWeeks + 6;
      }

      const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];
      const hours = Array.from({ length: 13 }, (_, i) => i + 8);

      const getWeekDates = () => {
        return weekdays.map((_, i) => {
          const date = new Date(currentWeekStart);
          date.setDate(currentWeekStart.getDate() + i);
          return date;
        });
      };

      const weekDates = getWeekDates();

      const loadBookings = async () => {
        setLoading(true);
        try {
          const response = await fetch(SCRIPT_URL);
          const data = await response.json();
          setBookings(data);
          setLastRefresh(new Date());
        } catch (error) {
          console.error('Error loading bookings:', error);
          alert('Failed to load bookings.');
        }
        setLoading(false);
      };

      useEffect(() => {
        loadBookings();
      }, [currentWeekStart]);

      const handleSlotClick = (dayIndex, hour) => {
        const date = weekDates[dayIndex];
        const slotKey = `${formatDate(date)}-${hour}`;
        
        if (bookings[slotKey]) {
          setSelectedSlot({ dayIndex, hour, existing: bookings[slotKey] });
        } else {
          setSelectedSlot({ dayIndex, hour, existing: null });
          setBookingForm({ name: '', purpose: '' });
        }
      };

      const handleBooking = async () => {
        if (!bookingForm.name.trim() || !bookingForm.purpose.trim()) {
          alert('Please enter both name and purpose');
          return;
        }

        const date = weekDates[selectedSlot.dayIndex];
        setLoading(true);
        try {
          await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'book',
              date: formatDate(date),
              hour: selectedSlot.hour,
              name: bookingForm.name.trim(),
              purpose: bookingForm.purpose.trim()
            })
          });
          await loadBookings();
          setSelectedSlot(null);
          setBookingForm({ name: '', purpose: '' });
        } catch (error) {
          alert('Failed to create booking.');
        }
        setLoading(false);
      };

      const handleCancelBooking = async () => {
        const date = weekDates[selectedSlot.dayIndex];
        setLoading(true);
        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'cancel',
              date: formatDate(date),
              hour: selectedSlot.hour
            })
          });
          const result = await response.json();
          if (result.success) {
            await loadBookings();
            setSelectedSlot(null);
          } else {
            alert('Failed to cancel: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          alert('Failed to cancel booking.');
        }
        setLoading(false);
      };

      const changeWeek = (direction) => {
        const newDate = new Date(currentWeekStart);
        newDate.setDate(currentWeekStart.getDate() + (direction * 7));
        setCurrentWeekStart(newDate);
      };

      const isBooked = (dayIndex, hour) => {
        const date = weekDates[dayIndex];
        const slotKey = `${formatDate(date)}-${hour}`;
        return bookings[slotKey];
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-2 md:p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4">
              <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
                <div className="flex items-center gap-2">
                  <Calendar className="w-6 h-6 md:w-8 md:h-8 text-indigo-600" />
                  <h1 className="text-xl md:text-3xl font-bold text-gray-800">Society Room Booking</h1>
                </div>
                <div className="flex items-center gap-3 w-full md:w-auto">
                  <div className="flex items-center gap-2 text-xs md:text-sm text-gray-600">
                    <Clock className="w-4 h-4" />
                    <span>8 AM - 9 PM (Sun-Thu)</span>
                  </div>
                  <button onClick={loadBookings} disabled={loading} className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 text-sm">
                    <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                    Refresh
                  </button>
                </div>
              </div>
              <div className="mt-2 text-xs text-gray-500">Last updated: {lastRefresh.toLocaleTimeString()}</div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-3 md:p-4 mb-4">
              <div className="flex items-center justify-between">
                <button onClick={() => changeWeek(-1)} disabled={loading} className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 text-sm">
                  ← Prev
                </button>
                <div className="text-lg font-semibold text-gray-700">Week {getWeekNumber()}</div>
                <button onClick={() => changeWeek(1)} disabled={loading} className="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 text-sm">
                  Next →
                </button>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-lg p-2 md:p-4 calendar-scroll">
              {loading && <div className="text-center py-8 text-gray-600">Loading...</div>}
              <div className={loading ? 'opacity-50' : ''} style={{display: 'grid', gridTemplateColumns: 'auto repeat(5, 1fr)', gap: '4px', minWidth: '600px'}}>
                <div className="font-semibold text-gray-700 p-2 text-xs">Time</div>
                {weekdays.map((day, i) => (
                  <div key={day} className="font-semibold text-gray-700 p-2 text-center text-xs">
                    <div>{day.substring(0, 3)}</div>
                    <div className="text-xs text-gray-500">{weekDates[i].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                  </div>
                ))}
                {hours.map(hour => (
                  <React.Fragment key={hour}>
                    <div className="p-2 text-xs text-gray-600 font-medium flex items-center">{hour}:00</div>
                    {weekdays.map((_, dayIndex) => {
                      const booking = isBooked(dayIndex, hour);
                      return (
                        <button key={`${dayIndex}-${hour}`} onClick={() => handleSlotClick(dayIndex, hour)} disabled={loading}
                          className={`p-2 rounded text-xs transition-all min-h-[60px] ${booking ? 'bg-red-100 hover:bg-red-200 border border-red-300' : 'bg-green-100 hover:bg-green-200 border border-green-300'}`}>
                          {booking ? (
                            <div className="text-left">
                              <div className="font-semibold text-red-800 truncate text-xs">{booking.name}</div>
                              <div className="text-xs text-red-600 truncate hidden md:block">{booking.purpose}</div>
                            </div>
                          ) : (
                            <div className="text-center text-green-700 font-medium">✓</div>
                          )}
                        </button>
                      );
                    })}
                  </React.Fragment>
                ))}
              </div>
            </div>

            {selectedSlot && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={() => setSelectedSlot(null)}>
                <div className="bg-white rounded-lg shadow-xl p-4 md:p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-gray-800">{selectedSlot.existing ? 'Booking Details' : 'New Booking'}</h2>
                    <button onClick={() => setSelectedSlot(null)} className="text-gray-500 hover:text-gray-700">
                      <X className="w-6 h-6" />
                    </button>
                  </div>

                  <div className="mb-4 p-3 bg-indigo-50 rounded-lg">
                    <div className="text-sm text-gray-600">{weekdays[selectedSlot.dayIndex]}, {weekDates[selectedSlot.dayIndex].toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</div>
                    <div className="text-lg font-semibold text-gray-800">{formatTime(selectedSlot.hour)} - {formatTime(selectedSlot.hour + 1)}</div>
                  </div>

                  {selectedSlot.existing ? (
                    <div>
                      <div className="mb-4 space-y-2">
                        <div className="flex items-center gap-2 text-gray-700">
                          <User className="w-5 h-5" />
                          <span className="font-semibold">{selectedSlot.existing.name}</span>
                        </div>
                        <div className="flex items-center gap-2 text-gray-700">
                          <Home className="w-5 h-5" />
                          <span>{selectedSlot.existing.purpose}</span>
                        </div>
                      </div>
                      <button onClick={handleCancelBooking} disabled={loading} className="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold disabled:bg-gray-400">
                        {loading ? 'Cancelling...' : 'Cancel This Booking'}
                      </button>
                    </div>
                  ) : (
                    <div>
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                        <input type="text" value={bookingForm.name} onChange={(e) => setBookingForm({ ...bookingForm, name: e.target.value })}
                          className="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter your name" disabled={loading} />
                      </div>
                      <div className="mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Purpose of Meeting</label>
                        <input type="text" value={bookingForm.purpose} onChange={(e) => setBookingForm({ ...bookingForm, purpose: e.target.value })}
                          className="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter meeting purpose" disabled={loading} />
                      </div>
                      <button onClick={handleBooking} disabled={loading} className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold disabled:bg-gray-400">
                        {loading ? 'Booking...' : 'Confirm Booking'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>